<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="navbar">
        <h1>Twitch Top Games</h1>
        <div class="navbar__game"><!-- 等等在這裡插入 span  --></div>
    </div>
    <div class="wallpaper">
        <div class="mainWrapper">
            <h2 class="game__name"></h2>
            <p>Top 20 popular live streams sorted by current viewers</p>
            <div class="box__wrapper"><!-- 等等在這裡插入 div  --></div>
        </div>
    </div>
    <img src="" alt="">
    <script>
        const navbarRequest = new XMLHttpRequest() // new 一個 AJAX 的 function
        const top5Url = 'https://api.twitch.tv/kraken/games/top'
        navbarRequest.open('GET',top5Url) // 設定 request 的方式（get or post 之類的）跟 網址
        navbarRequest.setRequestHeader('Client-ID', 'ny29dihtbce4ubq6bvgupsrojiv8uf') // 設定 header，twitch 需要的
        navbarRequest.setRequestHeader('Accept', 'application/vnd.twitchtv.v5+json') // 設定 header，twitch 需要的
        navbarRequest.send() // 發送出 request
        let top1 = '' // 設定 1~5 名
        let top2 = ''
        let top3 = ''
        let top4 = ''
        let top5 = ''
        navbarRequest.onload = function () {  // 當收到 response 之後啟動 function
            const navbarRequestResponse = JSON.parse(navbarRequest.response) // 轉換成 JSON 格式
            for (let i = 0; i < 5; i++){ // 用迴圈新增前五名
                const topGame = document.createElement("span") // 讓 document 新增一個元素標籤 span 
                topGame.classList.add("topGame")
                topGame.innerHTML = navbarRequestResponse.top[i].game.name // 把這個元素標籤的內部文字設定出來
                document.querySelector(".navbar__game").appendChild(topGame) // 去搜尋 navbar__game 底下新增上面這個元素標籤
                switch (i) {
                    case 0:
                        top1 = navbarRequestResponse.top[i].game.name
                    break;
                    case 1:
                        top2 = navbarRequestResponse.top[i].game.name
                    break;
                    case 2:
                        top3 = navbarRequestResponse.top[i].game.name
                    break;
                    case 3:
                        top4 = navbarRequestResponse.top[i].game.name
                    break;
                    case 4:
                        top5 = navbarRequestResponse.top[i].game.name
                    break;
                }
            }
            document.querySelector(".game__name").innerHTML = top1 // 預設顯示第一名
        }
        const boxRequest = new XMLHttpRequest() 
        const singleUrl = `https://api.twitch.tv/kraken/streams/?game=${top1}&limit=20`
        boxRequest.open('GET',singleUrl)
        boxRequest.setRequestHeader('Client-ID', 'ny29dihtbce4ubq6bvgupsrojiv8uf')
        boxRequest.setRequestHeader('Accept', 'application/vnd.twitchtv.v5+json')
        boxRequest.send()
        let spaceDefault = ['','','','','']
        let [preview,viewers,status,logo,display__name] = spaceDefault
        boxRequest.onload = function () {
            const boxRequestResponse = JSON.parse(boxRequest.response)
            for (let i = 0; i < 20; i++){
                preview = boxRequestResponse.streams[i].preview.medium
                viewers = boxRequestResponse.streams[i].viewers
                status = boxRequestResponse.streams[i].channel.status
                logo = boxRequestResponse.streams[i].channel.logo
                display__name = boxRequestResponse.streams[i].channel.display_name
                const template = 
                    `<div class="box">
                        <div class="preview">
                            <img src= "`+ preview + `" alt="">
                        </div>
                        <div class="detail">
                            <img class="logo" src="` + logo + `" alt="">
                            <div class="word">
                                <span class="status">` + status + `</span>
                                <div class="display__name__wrapper">
                                    <span class="display__name">` + display__name + `</span>
                                    <div class="viewers__wrapper">
                                        <span class="redSpot" > </span>
                                        <span class="viewers">` + viewers + `</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`
                const newTemplate = document.createElement("div")
                newTemplate.innerHTML = template
                document.querySelector(".box__wrapper").appendChild(newTemplate)
            }
            document.querySelector(".navbar__game").addEventListener('click',function (e) {
            if (e.target.classList.contains("topGame") ) {
                const nowSearch = e.target.closest("span").innerHTML // 設定現在點到的是哪個遊戲，取出名字
                const cleanAlive = document.querySelector(".alive")  // 搜尋之前是否有加上 alive 過
                cleanAlive?cleanAlive.classList.remove("alive"): // 如果有，移除它，沒有的話，不做事情
                document.querySelector(".game__name").innerHTML = nowSearch // 把 現在遊戲的名字改成 現在搜出來的
                document.querySelector(".box__wrapper").innerHTML = '' // 把 box 都清掉
                const boxRequest = new XMLHttpRequest() // 再 new 一次 AJAX
                const singleUrl = `https://api.twitch.tv/kraken/streams/?game=${nowSearch}&limit=20` // 這次的網址，要搜的是現在的遊戲
                boxRequest.open('GET',singleUrl) // 設定 request 的方法跟 url
                boxRequest.setRequestHeader('Client-ID', 'ny29dihtbce4ubq6bvgupsrojiv8uf')
                boxRequest.setRequestHeader('Accept', 'application/vnd.twitchtv.v5+json') // 設定 twitch 需要的 header
                boxRequest.send() // 發送出去
                e.target.classList.toggle("alive") // 放離上面的 alive 太近會一起被清掉，不知道為什麼，所以放離上面遠一點點，就不會有這個問題
                boxRequest.onload = function () { // 如果收到 respose 後，執行的 function
                    const boxRequestResponse = JSON.parse(boxRequest.response) // 把 response 取出
                    let spaceDefault = ['','','','',''] // 解構
                    let [preview,viewers,status,logo,display__name] = spaceDefault // 全部設定成空值
                    for (let i = 0; i < 20; i++){
                        preview = boxRequestResponse.streams[i].preview.medium 
                        viewers = boxRequestResponse.streams[i].viewers
                        status = boxRequestResponse.streams[i].channel.status
                        logo = boxRequestResponse.streams[i].channel.logo
                        display__name = boxRequestResponse.streams[i].channel.display_name
                        const template =  // 將值塞入模版
                            `<div class="box">
                                <div class="preview">
                                    <img src= "`+ preview + `" alt="">
                                </div><div class="detail">
                                    <img class="logo" src="` + logo + `" alt="">
                                    <div class="word">
                                        <span class="status">` + status + `</span>
                                        <div class="display__name__wrapper">
                                            <span class="display__name">` + display__name + `</span>
                                            <div class="viewers__wrapper">
                                                <span class="redSpot" > </span>
                                                <span class="viewers">` + viewers + `</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`
                        const newTemplate = document.createElement("div") // 宣告一個新的 div
                        newTemplate.innerHTML = template // 把模版塞入這個新的模版
                        document.querySelector(".box__wrapper").appendChild(newTemplate) // 新增上去
                    }
                
                }
            }
        })
    }
    </script>
</body>
</html>